<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 <mapper namespace="kr.co.itcruit.mapper.IEnterpriseBoardMapper">
 
	<sql id="boardSearch">
 		<if test="searchType != null and searchType == 'title'">
 			and (bbs_ttl like '%' || #{searchWord} || '%')
 		</if>
 		<if test="searchType != null and searchType == 'writer'">
 			and (bbs_writer '%' || #{searchWord} || '%')
 		</if>
 	</sql>
	
	<resultMap type="boardVO" id="boardMap">
 		<id property="bbsNo" column="bbs_no"/>
 		<result property="bbsNo" column="bbs_no"/>
 		<result property="bbsRegDt" column="bbs_reg_dt"/>
 		<result property="bbsInqCnt" column="bbs_inq_cnt"/>
 		<result property="bbsTtl" column="bbs_ttl"/>
 		<result property="bbsCn" column="bbs_cn"/>
 		<result property="bbsWriter" column="bbs_writer"/>
 		<result property="bbsCtgryCmmncd" column="bbs_ctgry_cmmncd"/>
 		<result property="bbsDelyn" column="bbs_delyn"/>
 		<collection property="atchFileList" resultMap="atchFileMap"/>
 	</resultMap>
 	
 	<resultMap type="atchVO" id="atchFileMap">
 		<id property="fileNo" column="file_no"/>
 		<result property="fileNo" column="file_no"/>
 		<result property="fileSrcNo" column="file_src_no"/>
 		<result property="orgnCmmncd" column="orgn_cmmncd"/>
 		<result property="filePath" column="file_path"/>
 		<result property="fileSize" column="file_size"/>
 		<result property="fileFancysize" column="file_fancysize"/>
 		<result property="fileMime" column="file_mime"/>
 		<result property="fileName" column="file_name"/>
 	</resultMap>
 	
 	<select id="selectEntBoardCount" parameterType="midPaginationVO" resultType="int">
 		select count(bbs_no)
 		from board
 		where 1=1
 		<include refid="boardSearch"/>
 	</select>
 
 	<select id="selectEntBoardList" parameterType="midPaginationVO" resultType="boardVO">
 		select 
			b.*
		from(
			select
				a.*, row_number() over(order by a.BBS_NO desc) rnum
			from(
				select 
					BBS_NO, BBS_TTL, BBS_CN, BBS_WRITER, BBS_REG_DT, BBS_INQ_CNT
				from BOARD
				  where 1=1
		          and bbs_ctgry_cmmncd = 'BBS202'
		          <include refid="boardSearch"/>
		          order by BBS_NO desc
			) a
		) b
		<![CDATA[
			where b.rnum >= #{startRow} and b.rnum <= #{endRow}
		]]>
 	</select>
 	
 	<insert id="insert" parameterType="boardVO" useGeneratedKeys="true">
 		<selectKey keyProperty="bbsNo" resultType="String" order="BEFORE">
 			select seq_board.nextval from dual
 		</selectKey>
			INSERT INTO board (
				bbs_no
				,bbs_ttl
				,bbs_cn
				,bbs_writer
				,bbs_ctgry_cmmncd
			) VALUES (
				#{bbsNo}
				,#{bbsTtl}
				,#{bbsCn}
				,#{bbsWriter}
				,'BBS202'
			)
 	</insert>
 	
 	<insert id="insertFile" parameterType="atchVO">
 		INSERT INTO atch (
		    file_no
		    , file_src_no
		    , orgn_cmmncd
		    , file_path
		    , file_size
		    , file_fancysize
		    , file_mime
		    , file_name
		) VALUES (
		    SEQ_ATCH.nextval
		  , #{fileSrcNo}
		  , #{orgnCmmncd}
		  , #{filePath}
		  , #{fileSize}
		  , #{fileFancysize}
		  , #{fileMime}
		  , #{fileName}
		)
 	</insert>
 	
 	<update id="incrementHit" parameterType="boardVO">
		update board
		set
			bbs_inq_cnt = bbs_inq_cnt +1
		where bbs_no = #{bbsNo}
	</update> 
	
	<select id="detail" parameterType="boardVO" resultMap="boardMap">
		SELECT
		    b.bbs_no as bbs_no
		  , bbs_reg_dt
		  , bbs_inq_cnt
		  , bbs_ttl
		  , bbs_cn
		  , bbs_writer
		  , bbs_ctgry_cmmncd
		  , bbs_delyn
		  , file_no
		  , a.file_src_no 
		  , orgn_cmmncd
		  , file_path
		  , file_size
		  , file_fancysize
		  , file_mime
		  , file_name
		from board b left outer join atch a on(b.bbs_no = a.FILE_SRC_NO)
		where bbs_no = #{bbsNo} 
		and BBS_CTGRY_CMMNCD = #{bbsCtgryCmmncd}
	</select>
 	
 
 </mapper>