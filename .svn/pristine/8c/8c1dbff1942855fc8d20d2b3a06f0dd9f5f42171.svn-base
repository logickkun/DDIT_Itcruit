<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://mozilla.github.io/pdf.js/build/pdf.js"></script>
<style>
        #pdf-container {
            width: 100%;
            height: 100%; /* 크기를 조정할 수 있습니다. */
        }
    </style>
<div class="page-content-wrapper border">

<div class="d-flex justify-content-flex-start mb-3" style="width: 50%;">
	<span class="h3 me-5">채용 공고 목록</span> 
		<select class="form-select" aria-label="Default select example" id="tabSelect" style="width: 50%;">
		<c:forEach items="${recruitList}" var="recruit">
			<option value="#tab-2-1" data-pstnCmmncdNm="${recruit.pstnCmmncdNm}" data-recruitNo="${recruit.recruitNo}">${recruit.recruitTtl}</option>
		</c:forEach>
	</select>
</div>

<div class="tab-content">

	<div class="tab-pane" id="tab-2-1">

		<ul class="nav nav-tabs nav-justified mb-3" id="tableTab">
		</ul>

		<div class="tab-content">

			<div class="tab-pane show active" id="tab-3-1">

				<div class="table-responsive border-0">

					<table class="table table-dark-gray align-middle p-4 mb-2 table-hover">
						<thead class="text-center">
							<tr id="tableHeader">
							</tr>
						</thead>

						<tbody class="text-center" id="tableBody">
						
						</tbody>
					</table>
				</div>
				
				
				<div class="d-sm-flex justify-content-sm-end align-items-sm-center" id="pagination-container">
					
				</div>
			</div>
		</div>
	</div>
</div>
</div>


<div class="modal fade" id="checkQstnAnswer" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
	<div class="modal-dialog modal-dialog-scrollable modal-xl" role="document">
	<div class="modal-content">
		<div class="modal-header">
		<h5 class="modal-title" id="modalLabel">지원접수 문항</h5>
		</div>
			<div class="modal-body">
			
				<div class="row">
				  <div class="col-4 col-sm-3">
				    <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
				    
				      
<!-- 				      <a class="nav-link" id="v-pills-profile-tab" data-bs-toggle="pill" href="#v-pills-profile" role="tab" aria-controls="v-pills-profile" aria-selected="false">2</a> -->
<!-- 				      <a class="nav-link" id="v-pills-messages-tab" data-bs-toggle="pill" href="#v-pills-messages" role="tab" aria-controls="v-pills-messages" aria-selected="false">3</a> -->
<!-- 				      <a class="nav-link" id="v-pills-settings-tab" data-bs-toggle="pill" href="#v-pills-settings" role="tab" aria-controls="v-pills-settings" aria-selected="false">4</a> -->
				    
				    </div>
				  </div>
				  <div class="col-8 col-sm-9">
				    <div class="tab-content pt-0" id="v-pills-tabContent">
				    
<!-- 				      <div class="tab-pane fade show active" id="v-pills-home" role="tabpanel" aria-labelledby="v-pills-home-tab"> -->
<!-- 				      	We have a strong foundation built on legacy and emerging technologies, including excellent track record of on-time deliveries. We are emerging as one of the most promising private talent sourcing and management firms in the world. The real challenge before companies in today's world is to make their products and services appealing to everyone. -->
<!-- 				    	</div> -->
				    	
				    	
<!-- 				      <div class="tab-pane fade" id="v-pills-profile" role="tabpanel" aria-labelledby="v-pills-profile-tab"> -->
<!-- 				      	We pride ourselves on the service we give to our clients. Our friendly team members are always willing to help you understand your present technology requirements and provide suggestions on your future needs. It can be the packaging of an item or the design of its website and Applications. -->
<!-- 				    	</div> -->
				
<!-- 				      <div class="tab-pane fade" id="v-pills-settings" role="tabpanel" aria-labelledby="v-pills-settings-tab"> -->
<!-- 				      	Our friendly team members are always willing to help you understand your present technology requirements and provide suggestions on your future needs. It can be the packaging of an item or the design of its website and Applications. We pride ourselves on the service we give to our clients. -->
<!-- 				    	</div> -->
				    	
				    </div>
				  </div>
				</div>
				
			</div>
		<div class="modal-footer">
		<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
		</div>
	</div>
	</div>
</div>

<div class="modal fade" id="pdfModal" tabindex="-1" role="dialog" aria-labelledby="pdfModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document"> <!-- 크기를 'modal-xl'로 설정 -->
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="pdfModalLabel">PDF Viewer</h5>
                <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <iframe id="pdfViewer" style="width:100%; height:800px;"></iframe> <!-- 높이를 증가 -->
            </div>
        </div>
    </div>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.6.347/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
<script>

const { jsPDF } = window.jspdf;
var tabSelect = $("#tabSelect");
var tableTab = $("#tableTab");
var recruitNo = tabSelect.find("option:selected").data("recruitno");
var pstnCmmncdNm = tabSelect.find("option:selected").data("pstncmmncdnm");
var paginationContainer = $("#pagination-container");
var tableBody = $("#tableBody");
var vPillsTab = $("#v-pills-tab");
var vPillsTabContent = $("#v-pills-tabContent");
var orderNumber = 1;
var modal;

$(function(){
	
	modal =  new bootstrap.Modal(document.getElementById("checkQstnAnswer"));
	
	tabSelect.on("change", function(){
			
		recruitNo = tabSelect.find("option:selected").data("recruitno");
		pstnCmmncdNm = tabSelect.find("option:selected").data("pstncmmncdnm");
// 		console.log("tabSelect : ", recruitNo, pstnCmmncdNm);
		
        getApplyProcessList(recruitNo, pstnCmmncdNm);
        
	});
	
	tableTab.on("click",".nav-link", function(){
		
		orderNumber = $(this).text().split("차")[0].trim();
		var clsNm = $(this).text().split("차")[1].trim();
// 		console.log("tableTab : ",recruitNo, pstnCmmncdNm, orderNumber);
		
		
		
		tableBody.html("");
		getApplicantList(recruitNo, pstnCmmncdNm, orderNumber, 1);
		getTableHeader(clsNm);
		
	});
	
	paginationContainer.on("click", "a.page-link", function(e){
		
		e.preventDefault();
        var page = $(this).data("page");
// 		console.log(page);

		getApplicantList(recruitNo, pstnCmmncdNm, orderNumber, page);
		
	})
	
	
	tableBody.on("click", ".qstnCheck", function() {
		
		var id = $(this).closest("tr").find("#accountId").val();
		
// 		console.log(id);
		
		getQstnAnswer(id, recruitNo, pstnCmmncdNm, orderNumber)
		
    });
	
	tableBody.on("click", ".resumeCheck", function() {
		
		var id = $(this).closest("tr").find("#accountId").val();
		
// 		console.log(id);

		getResumePdf(id);
    });
	
	tableBody.on("click", ".passBtn", function() {
		
		var applyNo = $(this).closest("tr").find("#applyNo").val();
		
// 		console.log(applyNo);
// 		console.log(orderNumber);

		if(confirm("합격 시키겠습니까?")){
			
// 			updateApplicantPass(applyNo, orderNumber, recruitNo, pstnCmmncdNm);
			$(this).closest("tr").remove();
		}
		
    });
	
	
	initTab();
	getApplyProcessList(recruitNo,pstnCmmncdNm);
	getApplicantList(recruitNo, pstnCmmncdNm, orderNumber, 1);
	
});



function initTab() {
	
	var selectedTabValue = tabSelect.find("option:selected").val();
	$(".tab-pane").removeClass("show active");
	$(".nav-link").removeClass("active");
	$(selectedTabValue).addClass("show active");
	$(selectedTabValue + " .nav-link:first").addClass("active");
	$(selectedTabValue + " .tab-pane:first").addClass("show active");

}

function getApplyProcessList(recruitNo, pstnCmmncdNm) {
	
	var tableTab = $("#tableTab");
    var tableTabHTML = "";
    var initClsNm = "";
	
	$.ajax({
		
		url : "/myPage/enterprise/getApplyProcessList",
		method : "GET",
		data : { recruitNo : recruitNo, pstnCmmncdNm : pstnCmmncdNm},
		success : function(res) {
			
			$.each(res, function(idx, list) {
				
				if(idx == 0){
					
	                tableTabHTML += 
	                '<li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" data-order="'+
					list.applyProcessOrder + 
					'" href="#tab-' + list.applyProcessOrder +
					'">' + list.applyProcessOrder + '차 ' + list.clsNm + '</a></li>';
					
					//
					initClsNm = list.clsNm;
					
				}else{
					
	                tableTabHTML += 
                	'<li class="nav-item"><a class="nav-link" data-bs-toggle="tab" data-order="' +
					list.applyProcessOrder + '" href="#tab-' + list.applyProcessOrder +
					'">' + list.applyProcessOrder + '차 ' + list.clsNm + '</a></li>';
				}
				
            });
			
			tableTab.html(tableTabHTML);
			getTableHeader(initClsNm);
		}
		
	});
}

function getTableHeader(clsNm) {
	
	var tableHeader = $("#tableHeader");
	var tableHeaderHTML = "";
	
	if(clsNm === "지원 접수"){
		
		tableHeaderHTML +=
			
			'<th scope="col" class="border-0 rounded-start" style="width: 400px;">지원자명</th>'+
			'<th scope="col" class="border-0" style="width: 180px;">나이</th>'+
			'<th scope="col" class="border-0" style="width: 180px;">성별</th>'+
			'<th scope="col" class="border-0" style="width: 180px;">경력</th>'+
			'<th scope="col" class="border-0" style="width: 180px;">이력서</th>'+
			'<th scope="col" class="border-0" style="width: 180px;">문항보기</th>'+
			'<th scope="col" class="border-0" style="width: 180px;">합격여부</th>'+
			'<th scope="col" class="border-0 rounded-end"></th>';
			
	}else if(clsNm === "화상 채팅"){
		
		
		
		
	}else if(clsNm === "Coding text"){
		
		tableHeaderHTML +=
			
			'<th scope="col" class="border-0 rounded-start" style="width: 400px;">지원자명</th>'+
			'<th scope="col" class="border-0" style="width: 180px;">나이</th>'+
			'<th scope="col" class="border-0" style="width: 180px;">성별</th>'+
			'<th scope="col" class="border-0" style="width: 180px;">점수</th>'+
			'<th scope="col" class="border-0" style="width: 180px;">걸린시간</th>'+
			'<th scope="col" class="border-0" style="width: 180px;">문항보기</th>'+
			'<th scope="col" class="border-0" style="width: 180px;">합격여부</th>'+
			'<th scope="col" class="border-0 rounded-end"></th>';
		
	}
	
	tableHeader.html(tableHeaderHTML);
}

function getApplicantList(recruitNo, pstnCmmncdNm, orderNumber, page) {
	
	
	var tableBodyHTML = "";
	
	$.ajax({
		
		url : "/myPage/enterprise/getOrderList",
		method : "GET",
		data : {recruitNo : recruitNo, pstnCmmncdNm : pstnCmmncdNm, orderNumber : orderNumber, page: page},
		success : function(res) {
			updateTable(res.dataList)
			updatePagination(res.pagingHTML);
		}
		
	});	
	
}
function updateTable(dataList){
	
	var tableBody = $("#tableBody");
	var tableBodyHTML = "";
	
	$.each(dataList, function(idx, list) {
		
		
		
		
    	var birthDate = new Date(list.birthYmd);
        var today = new Date();
        var age = today.getFullYear() - birthDate.getFullYear();
		
        if (today.getMonth() < birthDate.getMonth() || 
            (today.getMonth() === birthDate.getMonth() && today.getDate() < birthDate.getDate())) {
            age--;
        }
        
        var sex = "";
        if(list.gender === 'M')
        {sex = "남자";}
        else{sex = "여자";}
        
        
        
        tableBodyHTML +=
       	
		'<tr>'+
			'<input type="hidden" id="accountId" value="'+list.accountId+'">'+
			'<input type="hidden" id="applyNo" value="'+list.applyNo+'">'+
			'<td>'+
				'<div>'+
					'<div>'+
						'<h6 style="padding-right: 80px;">'+list.accountNm+'</h6>'+
						'<span class="text-body small"><i class="fas fa-fw fa-map-marker-alt me-1 mt-1"></i>'+list.accountAddr1+'</span>'+
					'</div>'+
				'</div>'+
			'</td>'+
			'<td>'+
				'<h6>만 '+age+'세</h6>'+
			'</td>'+
			'<td>'+
				'<h6>'+sex+'</h6>'+
			'</td>'+
			'<td>'+
				'<h6>'+list.rsmCareerYear+'</h6>'+
			'</td>'+
			'<td>'+
				'<h6>'+
					'<i class="bi bi-file-earmark-pdf resumeCheck" style="font-size: 30px;"></i>'+
				'</h6>'+
			'</td>'+
			
			'<td>'+
				'<h6>'+
					'<i class="bi bi-clipboard-check qstnCheck" style="font-size: 30px;"></i>'+
				'</h6>'+
			'</td>'+
			
			'<td>'+
				'<button type="button" class="btn btn-success passBtn">합격</button>'+
			'</td>'+
				
			'<td>'+
				'<div class="form-check">'+
					'<input class="form-check-input" type="checkbox" value="" id="flexCheckDefault"> <label class="form-check-label" for="flexCheckDefault"></label>'+
				'</div>'+
			'</td>'+
		'</tr>';
		
        tableBody.html(tableBodyHTML);
        
        
        
	});
	
}

function updatePagination(pagingHTML) {
	
	paginationContainer.html(pagingHTML);
	
}

function getQstnAnswer(id, recruitNo, pstnCmmncdNm, orderNumber) {
	
	
	
	var qstnAnswer = { 
			
			id: id, 
			recruitNo : recruitNo, 
			pstnCmmncdNm : pstnCmmncdNm , 
			orderNumber : orderNumber
			
	};
	
	
	$.ajax({
	
		url : "/myPage/enterprise/getQstnAnswer",
		method : "POST",
		contentType : "application/json; charset=utf-8",
		data : JSON.stringify(qstnAnswer),
		beforeSend: function(xhr) {
            xhr.setRequestHeader(header, token);
        },
		success : function (res) {
			
			var orderListHTML = "";
			var qstnAnswerListHTML = "";
			
			$.each(res, function(idx, list){
				
				
				
				if(idx == 0){
					
					orderListHTML +=
					'<a class="nav-link active" id="v-pills-home-tab" data-bs-toggle="pill" href="#v-pills-'+idx+'" role="tab" aria-controls="v-pills-home" aria-selected="true">'+(idx+1)+' 문항</a>'
						
					
					qstnAnswerListHTML +=
						
					'<div class="tab-pane fade show active" id="v-pills-'+idx+'" role="tabpanel" aria-labelledby="v-pills-messages-tab">'+
						'<div class="container mt-2">'+
							'<div id="qstn" class="p-3 mb-2 bg-light border border-primary">'+list.ENT_INTRO_QSTN_CN+'</div>'+
							'<div id="answer" class="p-3 bg-light border border-success">'+list.ENT_INTRO_QSTN_ANSR+'</div>'+
						'</div>'+
					'</div>';
					
				}else{
					
					orderListHTML +=
					'<a class="nav-link" id="v-pills-home-tab" data-bs-toggle="pill" href="#v-pills-'+idx+'" role="tab" aria-controls="v-pills-home" aria-selected="true">'+(idx+1)+' 문항</a>'
						
					
					qstnAnswerListHTML +=
						
					'<div class="tab-pane fade" id="v-pills-'+idx+'" role="tabpanel" aria-labelledby="v-pills-messages-tab">'+
						'<div class="container mt-2">'+
							'<div id="qstn" class="p-3 mb-2 bg-light border border-primary">'+list.ENT_INTRO_QSTN_CN+'</div>'+
							'<div id="answer" class="p-3 bg-light border border-success">'+list.ENT_INTRO_QSTN_ANSR+'</div>'+
						'</div>'+
					'</div>';
					
				}
				
				
			})
			vPillsTab.html(orderListHTML);
			vPillsTabContent.html(qstnAnswerListHTML);
			
		}
		
	});
	
	modal.show();
	
}

function getResumePdf(id){
	
	$.ajax({
		
		url : "/myPage/enterprise/getResumePdf",
		method : "GET",
		data : {id : id},
		beforeSend: function(xhr) {
            xhr.setRequestHeader(header, token);
        },
		success : function(res) {
			
			console.log(res);
			
			var doc = new jsPDF("p", "mm", "a4");
			var font = res.font; 
			var fontBold = res.fontBold;

			// 일반 및 볼드 폰트 추가
			doc.addFileToVFS("malgun.ttf", font);
			doc.addFont("malgun.ttf", "malgun", "normal");

			doc.addFileToVFS("malgunbd.ttf", fontBold);
			doc.addFont("malgunbd.ttf", "malgun", "bold");

			doc.setFont("malgun");

			doc.setFontSize(18);
			doc.text("이력서", 105, 20, { align: "center" });

			doc.setTextColor(100, 100, 100);
			doc.line(10, 25, 200, 25);  

			doc.setTextColor(0, 0, 0); 
			doc.rect(15, 30, 40, 45);  

			doc.setFontSize(11);
			doc.text("이름 : ", 65, 35);
			doc.text("연락처 : ", 65, 45);
			doc.text("이메일 : ", 65, 55);
			doc.text("주소 : ", 65, 65);

			doc.text("성별 : ", 145, 35);
			doc.text("생년월일 : ", 145, 45);

			doc.text("최현명", 80, 35);
			doc.text("010-6369-5404", 80, 45);
			doc.text("c.hyunmyung@gmail.com", 80, 55);
			doc.text("대전 서구 배재로 99-15 다정빌라", 80, 65);
			doc.text("남자", 155, 35);
			doc.text("1995/11/28", 165, 45);
			

			doc.setFontSize(17);
			doc.text("학 력 사 항", 15, 85, { align: 'left' });

			doc.setDrawColor(0);
			doc.setLineWidth(0.5);

			doc.setFontSize(14);
			doc.autoTable({
			    head: [['졸 업 년 월', '학 교 명', '전 공 / 분 야']],
			    body: [
			        ['2019/03/21', '전남대학교', '통계학과(중퇴)'],
			        ['Cell 4', 'Cell 5', 'Cell 6'],
			        ['Cell 7', 'Cell 8', 'Cell 9'],
			        ['Cell 10', 'Cell 11', 'Cell 12']
			    ],
			    startY: 90,
			    theme: 'grid',
			    styles: { font: 'malgun', lineColor: [0, 0, 0], lineWidth: 0.5, minRowHeight: 20},
			    headStyles: {
			        fillColor: [220, 220, 220],
			        textColor: [0, 0, 0],
			        fontStyle: 'bold' // 볼드 스타일 적용
			    },
			    bodyStyles: { minRowHeight: 30 }
			});

			doc.setFontSize(17);
			doc.text("경 력 사 항", 15, 145, { align: 'left' });
			doc.autoTable({
			    head: [['기 간', '근 무 처', '직 위', '업 무 내 용']],
			    body: [
			        ['2019/03/21', '삼성 소프트웨어', '사원', '임베디드 구현'],
			        ['2019/03/21', '삼성 소프트웨어', '사원', '임베디드 구현'],
			        ['2019/03/21', '삼성 소프트웨어', '사원', '임베디드 구현'],
			        ['2019/03/21', '삼성 소프트웨어', '사원', '임베디드 구현']
			    ],
			    startY: 150,
			    theme: 'grid',
			    styles: { font: 'malgun', lineColor: [0, 0, 0], lineWidth: 0.5 },
			    headStyles: {
			        fillColor: [220, 220, 220],
			        textColor: [0, 0, 0],
			        fontStyle: 'bold' // 볼드 스타일 적용
			    },
			    bodyStyles: { minRowHeight: 12 }
			});

			doc.setFontSize(17);
			doc.text("보 유 기 술 / 자 격 증", 15, 205, { align: 'left' });
			doc.autoTable({
			    head: [['취 득 년 월 일', '자 격 / 면 허 증', '시 행 처']],
			    body: [
			        ['2019/03/21', '삼성 소프트웨어', '사원'],
			        ['2019/03/21', '삼성 소프트웨어', '사원'],
			        ['2019/03/21', '삼성 소프트웨어', '사원'],
			        ['2019/03/21', '삼성 소프트웨어', '사원']
			    ],
			    startY: 210,
			    theme: 'grid',
			    styles: { font: 'malgun', lineColor: [0, 0, 0], lineWidth: 0.5 },
			    headStyles: {
			        fillColor: [220, 220, 220],
			        textColor: [0, 0, 0],
			        fontStyle: 'bold' // 볼드 스타일 적용
			    },
			    bodyStyles: { minRowHeight: 15 }
			});

			doc.setTextColor(100, 100, 100);
			doc.line(10, 287, 200, 287);

	            
            const pdfBlob = doc.output('blob');
            const blobUrl = URL.createObjectURL(pdfBlob);

            document.getElementById('pdfViewer').src = '/resources/pdfjs-4.2.67-dist/web/viewer.html?file=' + encodeURIComponent(blobUrl) + '#zoom=page-fit';
            $('#pdfModal').modal('show'); // Bootstrap 모달을 표시
		}
	});
}


function updateApplicantPass(applyNo, orderNumber, recruitNo, pstnCmmncdNm) {
	
	var obj = { 
			applyNo : applyNo,
			orderNumber : orderNumber,
			recruitNo : recruitNo,
			pstnCmmncdNm : pstnCmmncdNm
	}
	
	$.ajax({
		
		url:"/myPage/enterprise/updateApplicantPass",
		method : "POST",
		data : JSON.stringify(obj),
		contentType : "application/json; charset=utf-8",
		beforeSend: function(xhr) {
            xhr.setRequestHeader(header, token);
        },
		success : function(res) {
			
			if(res === "SUCCESS"){
				
				alert("합격되었습니다.");
				
			}
			
		}
	});
	
	
}
</script>
