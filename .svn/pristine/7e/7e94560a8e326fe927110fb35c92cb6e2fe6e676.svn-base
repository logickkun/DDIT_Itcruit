<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib uri="http://www.springframework.org/security/tags" prefix="sec"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>

<style>
.accordion-item {
	overflow: hidden;
}

.updateBtn, .deleteBtn {
	float: right;
	padding: 3px 6px 3px 10px;
	margin: 5px;
}

/* 목록 페이징 버튼 */

.pagination-primary-soft .page-link {
  font-size: 12px; /* 페이지네이션 링크의 폰트 크기 조절 */
  padding: 8px 10px; /* 페이지네이션 버튼의 패딩을 조절하여 크기 조절 */
  color: black; /* 페이지네이션 링크 텍스트 색상 */
  background-color: #DCD8FC; /* 페이지네이션 배경 색상 */
  border-color: #DCD8FC; /* 페이지네이션 테두리 색상 */
}

.pagination-primary-soft .page-item.active .page-link {
  color: black;
  background-color: #baabfc; /* 활성화된 페이지네이션 배경 색상 */
  border-color: #DCD8FC; /* 활성화된 페이지네이션 테두리 색상 */
}

.pagination-primary-soft .page-item.disabled .page-link {
  color: black; /* 비활성화된 페이지네이션 링크 텍스트 색상 */
  pointer-events: none; /* 비활성화된 페이지네이션 클릭 이벤트 방지 */
}

.pagination-primary-soft .page-item.disabled .page-link:hover {
  background-color: #fdfdfd; /* 비활성화된 페이지네이션 호버 배경 색상 */
  border-color: #ffffff; /* 비활성화된 페이지네이션 호버 테두리 색상 */
}

.pagination-primary-soft .page-item:hover .page-link {
  background-color: #DCD8FC; /* 호버시 배경색 없애기 */
  border-color: #DCD8FC; /* 호버시 테두리 색상 */
}
</style>


<!-- Page main content START -->
<div class="page-content-wrapper border">

	<!-- Title -->
	<div class="row">
		<div class="col-12">
			<h1 class="h3 mb-2 mb-sm-0">FAQ</h1>
		</div>
	</div>

	<!-- Card START -->
	<div class="card bg-transparent">

		<!-- Card header START -->
		<div class="card-header bg-transparent border-bottom px-0">
			<!-- Search and select START -->
			<div class="row g-3 align-items-center justify-content-between">

				<!-- Search bar -->
					<div class="col-md-4">
					<form class="input-group input-group-sm" method="get" id="searchForm">
						<input type="hidden" name="page" id="page"/>
						<div style="padding: 3px;"></div>
						<div class="input-group" style="width: 500px;">
						    <input type="text" name="searchWord" value="${searchWord }" class="form-control" placeholder="검색">
						    <div class="input-group-append">
						        <button type="submit" class="searchBtn" style="border:none; margin-top:10px; background-color: white;">
						            <i class="fas fa-search"></i>
						        </button>
						    </div>
						</div>
						<sec:csrfInput/>
					</form>
					</div>

				<!-- Primary button -->
				<div class="col-md-3 text-md-end">
					<a class="btn" data-bs-toggle="modal" data-bs-target="#viewReview" style="background-color: #DCD8FC;" href="#">등록하기</a>
				</div>
			</div>
			<!-- Search and select END -->
		</div>

		<!-- Card header END -->

		<!-- Card body START -->
		<div class="card-body px-4">

			<div class="table-responsive border-0">
				<table class="table table-dark-gray align-middle p-4 mb-0 table-hover">
					<!-- Table head -->
					<div class="accordion accordion-flush" id="accordionFlushExample">

						<c:set value="${pagingVO.dataList}" var="list" />
						<c:choose>
							<c:when test="${empty list}">
								<div>없다</div>
							</c:when>
							<c:otherwise>
								<form action="/myPage/admin/faqDelete.do" id="editdelForm" method="post">
									<input type="hidden" name="bbsNo" id="bbsNo" />
									<sec:csrfInput />
								</form>
								<div id="accordionFlushExample" class="accordion">
									<c:forEach items="${list}" var="faqList" varStatus="loop">
										<div class="accordion-item">
											<h2 class="accordion-header" id="flush-heading${loop.index}">
												<button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapse${loop.index}" aria-expanded="false" aria-controls="flush-collapse${loop.index}">${faqList.bbsTtl}</button>
											</h2>
											<div id="flush-collapse${loop.index}" class="accordion-collapse collapse" aria-labelledby="flush-heading${loop.index}" data-bs-parent="#accordionFlushExample">
												<div class="accordion-body">${faqList.bbsCn}</div>												
												<input type="button" class="deleteBtn" id="deleteBtn" data-bbsno="${faqList.bbsNo }" value="삭제 "> 
												<input type="button" class="updateBtn" id="updateBtn" data-bbsno="${faqList.bbsNo }" value="수정 ">
											</div>
										</div>
									</c:forEach>
								</div>
							</c:otherwise>
						</c:choose>
					</div>
				</table>
			</div>
		</div>
		<!-- Tabs content END -->
	</div>
	<div class="card-footer bg-transparent p-0">
		<!-- Pagination START -->
		<div class="d-sm-flex justify-content-sm-between align-items-sm-center">
			<!-- Content -->
			<p class="mb-0 text-center text-sm-start"></p>
			<!-- Pagination -->
			<div class="card-footer clearfix" id="pagingArea">
			${pagingVO.pagingHTML }
			</div>
		</div>
	</div>
</div>



<!-- Back to top -->
<div class="back-top">
	<i class="bi bi-arrow-up-short position-absolute top-50 start-50 translate-middle"></i>
</div>

<!-- Popup modal for reviwe START -->
<div class="modal fade" id="viewReview" tabindex="-1" aria-labelledby="viewReviewLabel" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content" style="height: 500px; width: 9000px;">
			<!-- Modal body -->
			<form action="/myPage/admin/faqInsert.do" method="post">
				<div class="modal-body">
					<div class="d-md-flex">
						<!-- Text -->
						<div>
							<div class="d-sm-flex items-center">
								<input type="text" name="bbsTtl" id="" placeholder="제목을 입력하세요" style="font-size: 30px; margin: 10px 10px; border: none; height: 50px; width: 100%;" required>
								<!-- Review star -->
							</div>
							<!-- Info -->
							<div class="form-floating">
								<textarea class="form-control" cols="20" rows="3"  wrap="hard" name="bbsCn" id="floatingTextarea2" style="width: 500px; height: 330px;" required></textarea>
								<label for="floatingTextarea2">내용을 입력해주세요</label>
							</div>
						</div>
					</div>
				</div>
				<!-- Modal footer -->
				<div class="modal-footer">
					<button type="submit" class="btn btn-light-soft my-0" data-bs-dismiss="modal" style="color: black;">답변 등록</button>
				</div>
				<sec:csrfInput />
			</form>
		</div>
	</div>
</div>
<!-- Popup modal for reviwe END -->

<script type="text/javascript">
// 	//사용자가 입력한 텍스트에서 엔터를 <br> 태그로 변환하는 함수
// 	function convertEnterToBr(text) {
// 	    return text.replace(/\n/g, "<br>");
// 	}
	
// 	// 텍스트 영역의 값이 변할 때마다 호출되는 함수
// 	function handleTextareaChange() {
// 	    var textarea = document.getElementById("floatingTextarea2");
// 	    var convertedText = convertEnterToBr(textarea.value);
// 	    // 변환된 텍스트를 다시 텍스트 영역에 설정
// 	    textarea.value = convertedText;
// 	}
	
// 	// 텍스트 영역의 값이 변할 때마다 변환 함수를 호출하도록 이벤트 리스너 추가
// 	document.getElementById("floatingTextarea2").addEventListener("input", handleTextareaChange);


	$(function() {

		var searchForm = $("#searchForm");
		var pagingArea = $("#pagingArea");

		pagingArea.on("click", "a", function(event) {
			event.preventDefault();
			var pageNo = $(this).data("page");
			console.log(pageNo)
			searchForm.find("#page").val(pageNo);
			searchForm.submit();
		});
	});

	function toggleCollapse(button) {
		const targetId = button.getAttribute('data-bs-target');
		const target = document.querySelector(targetId);
		const isOpen = target.classList.contains('show');
		if (isOpen) {
			target.classList.remove('show');
		} else {
			const activeCollapse = document
					.querySelector('.accordion-collapse.show');
			if (activeCollapse) {
				activeCollapse.classList.remove('show');
			}
			target.classList.add('show');
		}
	}

	$(function() {
		$(".deleteBtn").on("click", function() {
			var bbsNo = $(this).data("bbsno");
			if (confirm("정말로 삭제하시겠습니까?")) {
				$("#bbsNo").val(bbsNo);
				$("#editdelForm").submit(); // 폼 제출
			}
		});
	});

	$('.updateBtn')
			.click(
					function() {
						var accordionItem = $(this).closest('.accordion-item');
						var bbsNo = $(this).data("bbsno");

						// FAQ 제목을 가져옵니다.
						var bbsTtl = accordionItem.find(
								'.accordion-header button').text().trim();

						// FAQ 내용을 가져옵니다.
						var faqContent = accordionItem.find('.accordion-body')
								.text().trim();

						// FAQ 제목을 입력 창으로 바꿉니다.
						var inputTitle = $('<input type="text" name="bbsTtl" class="form-control faqTitleInput" value="' + bbsTtl + '">');
						accordionItem.find('.accordion-header button')
								.replaceWith(inputTitle);

						// FAQ 내용을 입력 창으로 바꿉니다.
						var inputContent = $('<textarea name="bbsCn" class="form-control faqTextarea">'
								+ faqContent + '</textarea>');
						accordionItem.find('.accordion-body').replaceWith(
								inputContent);

						// 저장 버튼이 이미 존재한다면 제거합니다.
						accordionItem.find('.btnSaveBtn').remove();

						// 수정된 내용을 저장할 버튼을 생성합니다.
						var saveButton = $('<button class="btnSaveBtn" data-bbsno="' + bbsNo + '">저장</button>');

						// 저장 버튼을 추가합니다.
						accordionItem.find('.accordion-collapse').append(
								saveButton);
					});

	$(document).on(
			"click",
			".btnSaveBtn",
			function() {
				var accordionItem = $(this).closest('.accordion-item');
				var bbsNo = $(this).data("bbsno");
				var updatedTitle = accordionItem.find('.faqTitleInput').val()
						.trim();
				var updatedContent = accordionItem.find('.faqTextarea').val()
						.trim();

				// AJAX를 사용하여 요청 보내기
				$.ajax({
					url : "/myPage/admin/faqUpdate.do",
					type : "POST",
					data : {
						bbsNo : bbsNo,
						bbsTtl : updatedTitle,
						bbsCn : updatedContent
					},
					beforeSend : function(xhr) {
						xhr.setRequestHeader('X-CSRF-TOKEN', $(
								'meta[name="_csrf"]').attr('content'));
					},
					success : function(response) {
						// 성공적으로 요청이 처리된 경우 처리할 내용
						console.log(response);
						window.location.href = "/myPage/admin/faq.do"; // 대상 페이지로 이동
					},
					error : function(xhr, status, error) {
						// 요청이 실패한 경우 처리할 내용
						console.error(xhr.responseText);
					}
				});
			});
</script>