package kr.co.itcruit.mypage.member.controller;

import java.util.List;

import javax.inject.Inject;
import javax.servlet.http.HttpSession;

import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;

import kr.co.itcruit.enterprise.like.service.ILikeService;
import kr.co.itcruit.mypage.member.service.IMemberService;
import kr.co.itcruit.vo.AccountVO;
import kr.co.itcruit.vo.AvailLangListVO;
import kr.co.itcruit.vo.CustomUser;
import kr.co.itcruit.vo.MemberPageResumePaginationInfoVO;
import kr.co.itcruit.vo.ResumeVO;
import lombok.extern.slf4j.Slf4j;

@Slf4j
@Controller
@RequestMapping("/myPage/member")
public class MemberController {
	
	@Inject
	private IMemberService memService;
	@Inject
	private ILikeService likeService; // 관심기업, 채용 가져오는 서비스
	
	@PreAuthorize("hasAnyRole('ROLE_AUTH102')")
	@RequestMapping(value = "/index", method = RequestMethod.GET)
	public String index(HttpSession session, Model model) {
		
		String goPage = "";
//		String goPage = "memberPage/home";
		
		//[스프링 시큐리티] 회원 ID를 스프링 시큐리티 UserDetails 정보에서 가져오기
		CustomUser user = (CustomUser) SecurityContextHolder.getContext().getAuthentication().getPrincipal();
		AccountVO account = user.getAccount();
		
		if(account != null) {
			session.setAttribute("SessionInfo", account);
			goPage = "memberPage/home";
		}
		
		return goPage;
	}
	
	//회원마이페이지-이력서관리탭-이력서 목록보여주기
	@PreAuthorize("hasAnyRole('ROLE_AUTH102')")
	@RequestMapping(value = "/resumeManage", method = RequestMethod.GET)
	public String resumeManageList(
			
			@RequestParam(name="page", required = false, defaultValue ="1") int currentPage
			, @RequestParam(required = false, defaultValue = "defaultSort") String searchType
			, HttpSession session, Model model
			, ResumeVO resumeVO, AvailLangListVO availLangVO) {
		
		String goPage = "";
		
		//[스프링 시큐리티] 회원 ID를 스프링 시큐리티 UserDetails 정보에서 가져오기
		CustomUser user = (CustomUser) SecurityContextHolder.getContext().getAuthentication().getPrincipal();
		AccountVO account = user.getAccount();
		
		if(account != null) {
			
			resumeVO.setAccountId(account.getAccountId());
			
			List<ResumeVO> rsmLangList = memService.selectResume(resumeVO);
			System.out.println("rrrrrrrrrrr");
			System.out.println(rsmLangList);
			
			MemberPageResumePaginationInfoVO<ResumeVO> rsmManagePagingVO = new MemberPageResumePaginationInfoVO<ResumeVO>();
			rsmManagePagingVO.setAccountId(account.getAccountId());
			
			//현재 페이지 전달
			rsmManagePagingVO.setCurrentPage(currentPage);
			//총 게시글 수 가져오기
			int totalRecord = memService.selectResumeCount(rsmManagePagingVO);
			//총 게시글 전달 후, 총 페이지 설정
			rsmManagePagingVO.setTotalRecord(totalRecord);
			
			//데이터 목록 받아오기
			List<ResumeVO> dataList = memService.selectResumeList(rsmManagePagingVO);
			System.out.println("llllllll");
			System.out.println(dataList);
			
			rsmManagePagingVO.setDataList(dataList);
			
			session.setAttribute("SessionInfo", account);
			model.addAttribute("rsmManagePagingVO", rsmManagePagingVO);
			goPage = "memberPage/resumeManage";
        }
		
		return goPage;
	}
	
}
