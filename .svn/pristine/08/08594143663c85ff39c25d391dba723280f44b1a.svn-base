<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>

<script>
	var numnum = 1;
	
	document.addEventListener("DOMContentLoaded", function() {
		
		
		var selectedRecruitNo;
		var selectedpstnCmmncdNm;
		var tabSelect = document.getElementById("tabSelect");
		var processOrder = document.querySelectorAll(".processOrder");
		var selectedBox = document.getElementById("selectedBox");
	
		
		//탭 활성화 초기화 함수.
		function activateInitialTab() {
		 
			var initialTabId = tabSelect.value;
		
// 			console.log(initialTabId);
		
			var activePane = document.querySelector(initialTabId);

			if(activePane) {
				
				activePane.classList.add("show", "active");

				var firstSubTabLink = activePane.querySelector(".nav-link.active");
				var firstSubTabPaneId = firstSubTabLink ? firstSubTabLink.getAttribute("href") : null;
				var firstSubTabPane = firstSubTabPaneId ? document.querySelector(firstSubTabPaneId) : null;

				if(firstSubTabPane) {
					firstSubTabPane.classList.add("show", "active");
				}
				
			}
		}
		
		
		
		
		//탭 클릭 이벤트.
	 	selectedBox.addEventListener("click", function(e) {
			 
	        if (e.target && e.target.classList.contains("nav-link")) {
	        	
	            var tabId = event.target.getAttribute("href"); 
	            console.log("탭 클릭 : ", extractLastNumber(tabId)); 
				
	            function extractLastNumber(tabId) {
	                var parts = tabId.split('-');
	                var lastPart = parts[parts.length - 1];
	                numnum = lastPart;
	                return lastPart;
	            }
	            
	            loadPage(extractLastNumber(tabId), 1);
	        }
	    });
		
		
		function ajaxProcessList() {
			 
            if(tabSelect.selectedIndex !== -1) {
            	
                var selectedObj = tabSelect.options[tabSelect.selectedIndex];
                
                selectedRecruitNo = selectedObj.getAttribute("data-recruit-no");
                
                selectedpstnCmmncdNm = selectedObj.getAttribute("data-pstn-cmmncd-nm");
                
                //초기화.
                processOrder.forEach(function(orderElement) {
                    orderElement.innerHTML = "";
                });
                
                var xhr = new XMLHttpRequest();
                xhr.open("GET", "/myPage/enterprise/getApplyProcessList?recruitNo=" + encodeURIComponent(selectedRecruitNo) + "&pstnCmmncdNm=" + encodeURIComponent(selectedpstnCmmncdNm), true);
                xhr.onreadystatechange = function() {
                    if(xhr.readyState === XMLHttpRequest.DONE){
                        if(xhr.status === 200){
                        	
                            var res = JSON.parse(xhr.responseText);
                            
                            processOrder.forEach(function(orderElement) {
                                orderElement.innerHTML = ""; 
                            });

                            res.forEach(function(data, idx) {
                            	
                                var processList;
                                if (idx == 0) {
                                    processList = '<li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tab-3-' + (idx + 1) + '">' + data.clsNm + '</a></li>';
                                } else {
                                    processList = '<li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-3-' + (idx + 1) + '">' + data.clsNm + '</a></li>';
                                }
                                processOrder.forEach(function(orderElement) {
                                    orderElement.insertAdjacentHTML("beforeend", processList);
                                });
                                
                            });
                            
                        } else {
                            console.log("응답 실패");
                        }
                    }
                };

                xhr.send();
                loadPage(1, 1);                            

            }
            
        }
		
		var paginationContainer = document.getElementById("pagination-container");
		
	    paginationContainer.addEventListener("click", function(event) {
	        var target = event.target;
	        if (target.tagName === 'A' && target.dataset.page) {
	            event.preventDefault();
	            loadPage(numnum, target.dataset.page);
	        }
	    });
		
		
	    function loadPage(orderNumber, pageNumber) {
	        var xhr = new XMLHttpRequest();
	        xhr.open("GET", "/myPage/enterprise/getOrderList?recruitNo=" + encodeURIComponent(selectedRecruitNo) + "&pstnCmmncdNm=" + encodeURIComponent(selectedpstnCmmncdNm) + "&orderNumber=" + encodeURIComponent(orderNumber) + "&page=" + encodeURIComponent(pageNumber), true);
	        xhr.onreadystatechange = function() {
	            if (xhr.readyState === XMLHttpRequest.DONE) {
	                if (xhr.status === 200) {
	                    var res = JSON.parse(xhr.responseText);
	                    updateTable(res.dataList);
	                    updatePagination(res.pagingHTML);
	                } else {
	                    console.log("Error loading page");
	                }
	            }
	        };
	        xhr.send();
	    }
		
		
		function updateTable(dataList) {
			
		    var tableContent = "";
		    dataList.forEach(function(item, index) {
		    	console.log(item);
		    	
		    	//Date 변환.
		    	var birthDate = new Date(item.birthYmd); //태어난 날짜.
		        var today = new Date(); //현재 날짜.
		        var age = today.getFullYear() - birthDate.getFullYear();
				
		        if (today.getMonth() < birthDate.getMonth() || 
		            (today.getMonth() === birthDate.getMonth() && today.getDate() < birthDate.getDate())) {
		            age--;
		        }
		        
		        var sex = "";
		        if(item.gender === 'M'){
		        	
		        	sex = "남자";
		        	
		        }else{
		        	
		        	sex = "여자";		        	
		        }
		        

		        tableContent += 
		        	'<tr>' +
		            '<td>' +
		                '<div class="d-flex align-items-center position-relative">' +
		                    '<div class="avatar avatar-md">' +
		                        '<img src="${pageContext.request.contextPath}/resources/assets/images/avatar/09.jpg" class="rounded-circle" alt="">' +
		                    '</div>' +
		                    '<div class="mb-0 ms-3">' +
		                        '<h6 class="mb-0">' +
		                            '<a href="admin-instructor-detail.html" class="stretched-link">' + item.accountNm + '</a>' +
		                        '</h6>' +
		                        '<span class="text-body small"><i class="fas fa-fw fa-map-marker-alt me-1 mt-1"></i>' + item.accountAddr1 + '</span>' +
		                    '</div>' +
		                '</div>' +
		            '</td>' +
		            '<td class="text-center">' +
		                '<h6>만'+age+'세<h6>' +
		            '</td>' +
		            '<td class="text-center">' +
		                '<h6>'+ sex +'<h6>' +
		            '</td>' +
		            '<td class="text-center">' +
		                '<h6>'+item.rsmCareerYear+'<h6>' +
		            '</td>' +
		            '<td class="text-center">' +
		                '<a href="#" class="btn btn-light btn-round me-1 mb-1 mb-md-0" data-bs-toggle="tooltip" data-bs-placement="top" title="View"> <i class="bi bi-eye"></i></a>' +
		            '</td>' +
		            '<td class="text-center">' +
		                '<button type="button" class="btn btn-success passBtn">Success</button>' +
		            '</td>' +
		            '<td>' +
	                '<div class="form-check">'+
					  '<input class="form-check-input" type="checkbox" value="" id="flexCheckDefault">'+
					  '<label class="form-check-label" for="flexCheckDefault">'+
					  '</label>'+
					'</div>' +
		            '</td>' +
		        '</tr>';
		    });
		    document.getElementById("orderList").innerHTML = tableContent;
		}

		function updatePagination(pagingHTML) {
		    document.getElementById("pagination-container").innerHTML = pagingHTML;
		}
		
		
		tabSelect.addEventListener("change", function(e) {

// 			console.log("체인지 이벤트 발생!");
			
			var selectedIndex = e.target.selectedIndex;
// 			console.log(selectedIndex);
		
			var selectedObj = e.target.options[selectedIndex];
// 			console.log(selectedObj);
			
			var selectedTitle = selectedObj.text;
// 			console.log(selectedTitle);
			
			var selectedRecruitNo = selectedObj.getAttribute("data-recruit-no");
			var selectedpstnCmmncdNm = selectedObj.getAttribute("data-pstn-cmmncd-nm");
			
// 			console.log(selectedRecruitNo);
// 			console.log(selectedpstnCmmncdNm);
			
			
// 			console.log(processOrder);

		});
		
		var orderList = document.getElementById("orderList");

		orderList.addEventListener("click", function(e) {
			
			
			//passBt있는 요소를 찾고
		    if (e.target.classList.contains("passBtn")) {
		    	
		    	
		    	//거기서 가장 가까운 tr을 찾는다.
		        var currentRow = e.target.closest("tr"); 
		        
		        var rowData = {
		            index: currentRow.cells[0].textContent.trim(), 
		            name: currentRow.cells[1].querySelector("h6").textContent.trim(),
		            address: currentRow.cells[1].querySelector(".text-body").textContent.trim() 
		        };

		        if(confirm("합격 시키겠습니까?")) {
		        	
		        } else {
		        	
		        }

		    }
		});


		
		
		tabSelect.addEventListener("change", ajaxProcessList);
	 	activateInitialTab();
        ajaxProcessList(); 
	});
</script>
<style>
.table>:not(caption)>*>* {
	padding: 1rem 4rem;
}
</style>
<div class="page-content-wrapper border">

	<div class="d-flex justify-content-flex-start mb-3" style="width: 50%;">
		<span class="h3 me-5">채용 공고 목록</span> <select class="form-select" aria-label="Default select example" id="tabSelect" style="width: 50%;">
			<c:forEach items="${recruitList}" var="recruit" varStatus="status" >
				<option value="#tab-2-${status.index + 1}" data-recruit-no="${recruit.recruitNo}" data-pstn-cmmncd-nm="${recruit.pstnCmmncdNm}">
					${recruit.recruitTtl}
				</option>
			</c:forEach>
		</select>
	</div>

	<div class="tab-content">

		<div class="tab-pane" id="tab-2-1">

			<!-- 비동기로 탭을 불러와야함 각 채용공고의 프로세스 순서. -->
			<ul class="nav nav-tabs nav-justified mb-3 processOrder" id="selectedBox">


			</ul>

			<div class="tab-content">
			
			
				<div class="table-responsive border-0">
					
					<table class="table table-dark-gray align-middle p-4 mb-2 table-hover">

						<thead>
							<tr>
								<th scope="col" class="border-0 rounded-start" style="width: 400px;">지원자명</th>
								<th scope="col" class="border-0 text-center" style="width: 170px;">나이</th>
								<th scope="col" class="border-0 text-center" style="width: 100px;">성별</th>
								<th scope="col" class="border-0 text-center" style="width: 100px;">경력</th>
								<th scope="col" class="border-0 text-center" style="width: 186px;">이력서</th>
								<th scope="col" class="border-0 text-center" style="width: 100px;">합격여부</th>
								<th scope="col" class="border-0 rounded-end" style="width: 50px;"></th>
							</tr>
						</thead>
						
						<tbody id="orderList">
						
						
						
						
						</tbody>
					</table>
				
					<div id="pagination-container">
					
					
					</div>
				</div>
				
			</div>
		</div>
		
	</div>
</div>