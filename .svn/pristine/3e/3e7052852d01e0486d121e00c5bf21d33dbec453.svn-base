<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<%@ taglib uri="http://www.springframework.org/security/tags" prefix="sec" %>
<body>
<main>
    <section class="pb-0 py-lg-5">
        <div class="container">
        
            <div class="row">
                <div class="col-md-4">
                    <div class="d-flex justify-content-flex-start">
                        <button class="d-flex align-items-center" style="border: solid 1px; background-color: white;">
                            <i class="bi bi-files">불러오기</i>
                        </button>&nbsp;
                        <button id="newIntroBtn" class="d-flex align-items-center" style="border: solid 1px; background-color: white;">
                            <i class="bi bi-file-earmark-plus">새자소서</i>
                        </button>&nbsp;
                        <button id="deleteIntroBtn" class="d-flex align-items-center" style="border: solid 1px; background-color: white;">
                            <i class="bi bi-file-earmark-x">삭제</i>
                        </button>
                    </div>
                </div>
                <div class="col-sm-6">
                    <button class="d-flex align-items-center" style="border: solid 1px; background-color: white;" id="saveBtn">
                        <i class="bi bi-save">저장</i>
                    </button>
                </div>
                <div class="col-sm-2 text-right">
                    <div class="d-flex justify-content-end">
                        <input type="button" value="제출">
                    </div>
                </div>
                <form action="/recruit/insertAnswer.do" method="post" id="insertAnswer">
                <!-- Main content START -->
                <div class="col-lg-12">
                    <div class="card shadow rounded-2 p-0">
                        <!-- Tabs START -->
                        <div class="card-header border-bottom px-4 py-3">
                            <ul class="nav nav-pills nav-tabs-line py-0" id="course-pills-tab" role="tablist">
                                <!-- Tab items START -->
                                <c:choose>
                                    <c:when test="${empty dsnctList}">
                                        <li class="nav-item me-2 me-sm-1" role="presentation">
                                            <button class="nav-link mb-2 mb-md-0 active" 
                                                    id="course-pills-tab-1" 
                                                    data-bs-toggle="pill" 
                                                    data-bs-target="#course-pills-1" 
                                                    type="button" 
                                                    role="tab" 
                                                    aria-controls="course-pills-1" 
                                                    aria-selected="true">
                                                1
                                            </button>
                                        </li>
                                    </c:when>
                                    <c:otherwise>
                                        <c:forEach items="${dsnctList}" var="list" varStatus="loop">
                                            <li class="nav-item me-2 me-sm-1" role="presentation">
                                                <button class="nav-link mb-2 mb-md-0 ${loop.first ? 'active' : ''}" 
                                                        id="course-pills-tab-${loop.index + 1}" 
                                                        data-bs-toggle="pill" 
                                                        data-bs-target="#course-pills-${loop.index + 1}" 
                                                        type="button" 
                                                        role="tab" 
                                                        aria-controls="course-pills-${loop.index + 1}" 
                                                        aria-selected="${loop.first ? 'true' : 'false'}">
                                                    ${loop.index + 1}
                                                </button>
                                            </li>
                                        </c:forEach>
                                    </c:otherwise>
                                </c:choose>
                                <!-- Tab items END -->
                            </ul>
                        </div>
                        <!-- Tabs END -->
                        <!-- Tab contents START -->
                        <div class="card-body p-4">
                            <div class="tab-content pt-2" id="course-pills-tabContent">
                                <!-- Card contents START -->
                                <c:choose>
                                    <c:when test="${empty dsnctList}">
                                        <div class="tab-pane fade show active" 
                                            id="course-pills-1" 
                                            role="tabpanel" 
                                            aria-labelledby="course-pills-tab-1">
                                            <!-- Card content START -->
                                            <h5 class="mb-3">제목</h5>
                                            <textarea name="problem" 
                                                    id="problem1" 
                                                    style="width: 100%; overflow: hidden; overflow-wrap: break-word; border: none; resize: none;" 
                                                    cols="auto" 
                                                    rows="5"  
                                                    placeholder="답변을 입력하세요"></textarea>
                                            <div style="text-align: right;">
                                                <input type="button" value="오류신고"></input>
                                            </div>
                                            <br/><hr/>
                                            <textarea style="width: 100%; height: 150px; resize: vertical; border: none;" 
                                                    placeholder="답변을 입력하세요"></textarea>
                                            <!-- Card content END -->
                                            <div style="display: flex; align-items: center;">
                                                <div style="width: 500px;">
                                                    0 / 1000 (글자 수, 공백 포함)
                                                </div>
                                                <div class="progress progress-percent-bg" style="flex-grow: 1; margin-left: 10px;">
                                                    <div class="progress-bar progress-bar-striped bg-info" 
                                                        role="progressbar" 
                                                        style="width: 50%" 
                                                        aria-valuenow="50" 
                                                        aria-valuemin="0" 
                                                        aria-valuemax="100">
                                                        <span class="progress-percent">80%</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </c:when>
                                    <c:otherwise>
                                        <c:forEach items="${dsnctList}" var="list" varStatus="loop">
                                            <div class="tab-pane fade ${loop.first ? 'show active' : ''}" 
                                                id="course-pills-${loop.index + 1}" 
                                                role="tabpanel" 
                                                aria-labelledby="course-pills-tab-${loop.index + 1}">
                                                <!-- Card content START -->
                                                <h5 class="mb-3">${recruit.entNm} ${recruit.recruitTtl}</h5>
                                                <textarea name="problem" 
                                                        id="problem${loop.index + 1}" 
                                                        style="width: 100%; overflow: hidden; overflow-wrap: break-word; border: none; resize: none;" 
                                                        cols="auto" 
                                                        rows="5"  
                                                        placeholder="${list.entIntroQstnCn}" 
                                                        disabled></textarea>
                                                <div style="text-align: right;">
                                                    <input type="button" value="오류신고"></input>
                                                </div>
                                                <br/><hr/>
                                                <textarea class="textBox" 
                                                        style="width: 100%; height: 150px; resize: none; border: none;" 
                                                        maxlength="1000" 
                                                        placeholder="답변을 입력하세요"></textarea>
                                                <!-- Card content END -->
                                                <div style="display: flex; align-items: center;">
                                                    <div class="textCount" style="width: 500px;"></div>
                                                    <div class="progress progress-percent-bg" style="flex-grow: 1;margin-left: 10px;">
                                                        <div class="progress-bar progress-bar-striped bg-info" 
                                                            role="progressbar" 
                                                            style="width: 50%" 
                                                            aria-valuenow="50" 
                                                            aria-valuemin="0" 
                                                            aria-valuemax="100">
                                                            <span class="progress-percent" style="margin-right: -10px"></span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </c:forEach>
                                    </c:otherwise>
                                </c:choose>
                                <!-- Card contents END -->
                            </div>
                        </div>
                        <!-- Tab contents END -->
                    </div>
                </div>
                <!-- Main content END -->
                <sec:csrfInput/>
        		</form>
            </div><!-- Row END -->
        
        </div>
    </section>
</main>
</body>
<script>
$(function(){
    var newIntroBtn = $("#newIntroBtn");
    var deleteIntroBtn = $("#deleteIntroBtn");

    newIntroBtn.on("click", function(){
        var tabList = $("#course-pills-tab");
        var tabCounter = tabList.children().length + 1; // 현재 탭 개수 + 1

        // 탭 아이콘 추가
        var newTab = $("<li class='nav-item me-2 me-sm-1' role='presentation'>" +
            "<button class='nav-link mb-2 mb-md-0' id='course-pills-tab-" + tabCounter + "' data-bs-toggle='pill' data-bs-target='#course-pills-" + tabCounter + "' type='button' role='tab' aria-controls='course-pills-" + tabCounter + "' aria-selected='false'>" + tabCounter + "</button>" +
            "</li>");
        tabList.append(newTab);

        // 탭에 해당하는 내용 추가
        var tabContent = $("#course-pills-tabContent");
        var newContent = $("<div class='tab-pane fade' id='course-pills-" + tabCounter + "' role='tabpanel' aria-labelledby='course-pills-tab-" + tabCounter + "'>" +
       	    "<h5 class='mb-3'>제목</h5>" +
       	    "<textarea name='problem' id='problem" + tabCounter + "' style='width: 100%; overflow: hidden; overflow-wrap: break-word; border: none; resize: none;' cols='auto' rows='5' placeholder='답변을 입력하세요'></textarea>" +
       	    "<div style='text-align: right;'>" +
       	    "<input type='button' value='오류신고'>" +
       	    "</div>" +
       	    "<br/><hr/>" +
       	    "<textarea class='textBox' style='width: 100%; height: 150px; resize: none; border: none;' maxlength='1000' placeholder='답변을 입력하세요'></textarea>" +
       	    "<div style='display: flex; align-items: center;'>" +
       	    "<div class='textCount' style='width: 500px;'></div>" +
       	    "<div class='progress progress-percent-bg' style='flex-grow: 1;margin-left: 10px;'>" +
       	    "<div class='progress-bar progress-bar-striped bg-info' role='progressbar' style='width: 50%' aria-valuenow='50' aria-valuemin='0' aria-valuemax='100'><span class='progress-percent' style='margin-right: -10px'></span></div>" +
       	    "</div>" +
       	    "</div>" +
       	    "</div>");
       	tabContent.append(newContent);

        // 새로 추가된 탭 활성화
        newTab.find("button").tab('show');
        initContent();
    });
    
    deleteIntroBtn.on("click", function(){
        var activeTab = $("#course-pills-tab .nav-link.active"); // 현재 활성화된 탭을 찾습니다.
        var tabItem = activeTab.closest("li.nav-item"); // 현재 탭 아이템을 찾습니다.
        var tabId = activeTab.attr("id"); // 활성화된 탭의 ID를 가져옵니다.
        var tabNumber = tabId.substring(tabId.lastIndexOf("-") + 1); // "-" 뒤의 번호를 가져옵니다.
//         console.log("삭제할 탭 번호:", tabNumber);

        // 삭제할 탭과 해당 내용을 삭제합니다.
        $("#course-pills-" + tabNumber).remove(); // 탭 내용 삭제
        tabItem.remove(); // 탭 삭제

        // 삭제된 탭 다음 탭을 활성화합니다.
        var nextTabNumber = parseInt(tabNumber) + 1;
        if (nextTabNumber > 1 && nextTabNumber <= $("#course-pills-tab").children().length) {
            $("#course-pills-tab-" + nextTabNumber).tab("show");
        } else {
            var prevTabNumber = parseInt(tabNumber) - 1;
            if (prevTabNumber >= 1) {
                $("#course-pills-tab-" + prevTabNumber).tab("show");
            }
        }

        // 남은 탭의 번호를 다시 조정합니다.
        $("#course-pills-tab .nav-link").each(function(index){
            $(this).text(index + 1);
            var targetId = $(this).attr("data-bs-target");
            var newTargetId = targetId.replace(/[^-]+$/, index + 1);
            $(this).attr("id", "course-pills-tab-" + (index + 1));
            $(this).attr("data-bs-target", newTargetId);
            $(this).attr("aria-controls", newTargetId);
            $(targetId).attr("id", "course-pills-" + (index + 1));
            $(targetId).attr("aria-labelledby", "course-pills-tab-" + (index + 1));
        });
        initContent();
    });



    
    var insertAnswer = $("#insertAnswer");
    var saveBtn = $("#saveBtn");
    
    saveBtn.on("click", function(){
        console.log("!!!!");
        
        // serializeAllTabs 함수를 호출하여 모든 탭의 textarea 값을 리스트로 가져옵니다.
        var formDataList = serializeAllTabs();
		console.log(formDataList);
        
        // AJAX 요청을 보냅니다.
        $.ajax({
            type: "POST",
            url: "/recruit/insertAnswer.do", // 서버 URL
            data: JSON.stringify(formDataList), // 리스트를 JSON 문자열로 변환하여 전송
            processData: false,
            beforeSend: function(xhr) {
                xhr.setRequestHeader(header, token);
            },
            contentType: "application/json",
            success: function(response) {
                // 성공적으로 요청을 처리한 경우 실행할 코드
                console.log("요청이 성공적으로 처리되었습니다.", response);
                // 여기에 성공 메시지 표시 등 추가 작업을 할 수 있습니다.
            },
            error: function(xhr, status, error) {
                // 요청을 처리하는 동안 오류가 발생한 경우 실행할 코드
                console.error("오류 발생:", error);
                // 여기에 오류 메시지 표시 등 추가 작업을 할 수 있습니다.
            }
        });
    });

    function serializeAllTabs() {
        var formDataList = [];

        // 모든 탭에 대해 반복하며 FormData를 생성하여 리스트에 추가합니다.
        $("#course-pills-tabContent .tab-pane").each(function() {
            var tabContent = this;
            console.log(tabContent);
            
            var tabIndex = tabContent.id.split("-")[2];
            console.log(tabIndex);
            
            var textareas = tabContent.querySelector("#problem"+tabIndex);
            console.log(textareas.getAttribute("placeholder"));
            
            var formData = new FormData();

            // 각 textarea의 값을 FormData에 추가
            textareas.forEach(function(textarea, index) {
                formData.append("tab" + tabIndex + "_textarea" + (index + 1), textarea.value);
            });

            // FormData를 리스트에 추가합니다.
            formDataList.push(formData);
        });

        return formDataList;
    }
    
//     });
    
  
    
});

function initContent() {
    $('.textCount').text('0 / 1000 (글자 수, 공백 포함)'); // 텍스트 카운트 초기화
    $('.progress-bar').css('width', '0%'); // 프로그레스 바 초기화
}
$(document).ready(function() {
    // 페이지가 로드될 때 초기값 설정
//     $('#textCount').text('0 / 1000 (글자 수, 공백 포함)'); // 텍스트 카운트 초기화
//     $('.progress-bar').css('width', '0%'); // 프로그레스 바 초기화
    initContent();
    
    // 텍스트 입력 시 이벤트 처리
    $('.textBox').keyup(function (e) {
        let content = $(this).val();
//         console.log(content);

        // 글자수 세기
        if (content.length == 0 || content == '') {
            $('.textCount').text('0 / 1000 (글자 수, 공백 포함)');
        } else {
            $('.textCount').text(content.length + ' / 1000 (글자 수, 공백 포함)');
        }

        // 글자수 제한
        if (content.length >= 1000) {
            // 1000자부터는 타이핑이 되지 않도록
            $(this).val(content.substring(0, 1000));
            // 1000자 넘으면 알림창 대신 텍스트 색상을 빨간색으로 변경
            $('.textCount').css('color', 'red');
        } else {
            $('.textCount').css('color', ''); // 기본색상으로 변경
        }

        // 프로그레스 바 너비 설정
        // 전체 글자 수 1000을 기준으로 너비를 계산
        let progressBarWidth = (content.length / 1000) * 100;
        $('.progress-bar').css('width', progressBarWidth + '%');
        $('.progress-percent').text(Math.floor(progressBarWidth) + '%');
    });
});
</script>

